<!DOCTYPE html>
<html lang="en">
<head>
  <title>Create Quiz</title>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Source+Sans+Pro:wght@300;600&display=swap" rel="stylesheet" />

  <!-- CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/vendor/normalize-4.1.1.css" />
  <link rel="stylesheet" href="/vendor/border-box.css" />
  <link rel="stylesheet" href="/styles/main.css" />
  <link rel="stylesheet" href="/styles/layout.css" />
  <link rel="stylesheet" href="/styles/login.css" />
  <link rel="stylesheet" href="/styles/createAccount.css" />
  <link rel="stylesheet" href="/styles/greeting.css" />
  <link rel="stylesheet" href="/styles/nav-bar-brand.css" />
  <link rel="stylesheet" href="/styles/nav-linkItems.css" />
  <link rel="stylesheet" href="/styles/quiz.css" />
  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script defer src="/scripts/app.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
  <%- include('./_header.ejs') %>
  <button id="createQuizButton" class="btn btn-primary">Create New Quiz</button>

  <main>
    <div id="newQuizForm" style="display: none;">
      <h1 class="create-new-quiz">Create a New Quiz</h1>
      <form class="quiz" id="quizForm">
        <label for="title">Quiz Title:</label>
        <input type="text" id="title" name="title" required />

        <label for="description">Description:</label>
        <textarea id="description" name="description"></textarea>

        <!-- Questions will be appended here -->
        <div id="questions"></div>

        <button type="button" id="addQuestion">Add Question</button>

        <input type="submit" value="Create Quiz" />
      </form>
    </div>
  </main>

  <script>
    let questionIndex = 0;

    function addQuestion() {
      const questionElement = $(`
        <div>
          <h2>Question ${questionIndex + 1}</h2>
          <button type="button" class="removeQuestion">Remove Question</button>
          <label for="questions[${questionIndex}].text">Question:</label>
          <input type="text" id="questions[${questionIndex}].text" name="questions[${questionIndex}].text" required />
          <button type="button" class="addChoice">Add Choice</button>
          <div class="choices"></div>
        </div>
      `);
      $('#questions').append(questionElement);

      let choiceIndex = 0;

      function addChoice() {
        const choicesElement = questionElement.find('.choices');
        choicesElement.append(`
          <div>
            <label for="questions[${questionIndex}].choices[${choiceIndex}].text">Choice ${choiceIndex + 1}:</label>
            <input type="text" id="questions[${questionIndex}].choices[${choiceIndex}].text" name="questions[${questionIndex}].choices[${choiceIndex}].text" required />
            <input type="checkbox" id="questions[${questionIndex}].choices[${choiceIndex}].is_correct" name="questions[${questionIndex}].choices[${choiceIndex}].is_correct" />
            <label for="questions[${questionIndex}].choices[${choiceIndex}].is_correct">Correct</label>
          </div>
        `);
        choiceIndex++;
      }

      questionElement.find('.addChoice').click(addChoice);
      questionElement.find('.removeQuestion').click(function() {
        questionElement.remove();
      });

      // Add a default choice
      addChoice();

      questionIndex++;
    }

    $('#addQuestion').click(addQuestion);

    // Add a default question
    addQuestion();

    // Handle form submission with jQuery and AJAX
    $('#quizForm').submit(function(event) {
      event.preventDefault(); // prevent the form from submitting normally

      // Prepare the quiz data structure
      const quizData = {
        title: $('#title').val(),
        description: $('#description').val(),
        questions: []
      };

      // Iterate over each question element and collect the data
      $('#questions > div').each(function() {
        const questionElement = $(this);
        const questionData = {
          text: questionElement.find('input[name^="questions"]').val(),
          choices: []
        };

        // Iterate over each choice element and collect the data
        questionElement.find('.choices > div').each(function() {
          const choiceElement = $(this);
          const choiceData = {
            text: choiceElement.find('input[name^="questions"]').val(),
            is_correct: choiceElement.find('input[type="checkbox"]').prop('checked')
          };
          questionData.choices.push(choiceData);
        });

        quizData.questions.push(questionData);
      });

      // AJAX POST request code
      $.ajax({
        type: 'POST',
        url: '/quizzes',
        data: JSON.stringify(quizData),
        contentType: 'application/json',
        success: function(data) {
          console.log(data);
          $('#newQuizForm').hide();
        },
        error: function(error) {
          console.error(error);
        }
      });
    });

    $('#createQuizButton').click(function() {
      $('#newQuizForm').show();
    });
  </script>

</body>
</html>
